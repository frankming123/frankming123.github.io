<!DOCTYPE html>
<html lang="zh_CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css">
  <script src="/lib/pace/pace.min.js"></script>


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    hostname: new URL('https://staight.github.io').hostname,
    root: '/',
    scheme: 'Mist',
    version: '7.7.0',
    exturl: false,
    sidebar: {"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},
    copycode: {"enable":true,"show_result":true,"style":"mac"},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    comments: {"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: '',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}
  };
</script>

  <meta name="description" content="简介configmap是Kubernetes中的一个资源对象，用来存储键值对数据，往往是配置信息，可以理解为整个命名空间的&#x2F;etc目录。 configmap可用于环境变量，命令行参数和挂载数据卷。值得一提的是，configmap还具备热更新的功能，接下来就让我们实践下吧。">
<meta property="og:type" content="article">
<meta property="og:title" content="configmap热更新">
<meta property="og:url" content="https://staight.github.io/2019/09/18/configmap%E7%83%AD%E6%9B%B4%E6%96%B0/index.html">
<meta property="og:site_name" content="staight">
<meta property="og:description" content="简介configmap是Kubernetes中的一个资源对象，用来存储键值对数据，往往是配置信息，可以理解为整个命名空间的&#x2F;etc目录。 configmap可用于环境变量，命令行参数和挂载数据卷。值得一提的是，configmap还具备热更新的功能，接下来就让我们实践下吧。">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2019-09-18T01:55:02.000Z">
<meta property="article:modified_time" content="2019-10-02T17:49:50.000Z">
<meta property="article:author" content="staight">
<meta property="article:tag" content="容器">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://staight.github.io/2019/09/18/configmap%E7%83%AD%E6%9B%B4%E6%96%B0/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true
  };
</script>

  <title>configmap热更新 | staight</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">staight</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
        <li class="menu-item menu-item-杂物">

    <a href="/sundries/" rel="section"><i class="fa fa-fw fa-calendar"></i>杂物</a>

  </li>
  </ul>

</nav>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

  <a href="https://github.com/staight" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh_CN">
    <link itemprop="mainEntityOfPage" href="https://staight.github.io/2019/09/18/configmap%E7%83%AD%E6%9B%B4%E6%96%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="staight">
      <meta itemprop="description" content="keep it simple and stupid">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="staight">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          configmap热更新
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-09-18 09:55:02" itemprop="dateCreated datePublished" datetime="2019-09-18T09:55:02+08:00">2019-09-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2019-10-03 01:49:50" itemprop="dateModified" datetime="2019-10-03T01:49:50+08:00">2019-10-03</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>configmap是Kubernetes中的一个资源对象，用来存储键值对数据，往往是配置信息，可以理解为整个命名空间的<code>/etc</code>目录。</p>
<p>configmap可用于环境变量，命令行参数和挂载数据卷。值得一提的是，configmap还具备热更新的功能，接下来就让我们实践下吧。</p>
<h2 id="热更新实践"><a href="#热更新实践" class="headerlink" title="热更新实践"></a>热更新实践</h2><p>首先，创建一个测试的configmap：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kubectl create -f test-cm.yml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">a:</span> <span class="string">"1"</span></span><br></pre></td></tr></table></figure>

<p>创建后，可以使用edit，apply或patch命令修改a的值：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl patch cm test -p &#39;&#123;&quot;data&quot;:&#123;&quot;a&quot;:&quot;2&quot;&#125;&#125;&#39;</span><br></pre></td></tr></table></figure>

<p>接下来，通过环境变量，命令行参数以及数据卷挂载这三种方式测试configmap的热更新效果。</p>
<h3 id="环境变量"><a href="#环境变量" class="headerlink" title="环境变量"></a>环境变量</h3><p>创建alpine容器，并使用test-cm作为环境变量：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kubectl create -f test-pod.yml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">alpine</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">alpine</span></span><br><span class="line">      <span class="attr">command:</span> <span class="string">[</span> <span class="string">"/bin/sleep"</span><span class="string">,</span> <span class="string">"3600"</span><span class="string">]</span></span><br><span class="line">      <span class="attr">envFrom:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">configMapRef:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">test</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Never</span></span><br></pre></td></tr></table></figure>

<p>查看test-pod的环境变量：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 test]# kubectl exec test -- env | grep a&#x3D;</span><br><span class="line">a&#x3D;1</span><br></pre></td></tr></table></figure>

<p>修改configmap后，再次查看test-pod的环境变量：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 test]# kubectl exec test -- env | grep a&#x3D;</span><br><span class="line">a&#x3D;1</span><br></pre></td></tr></table></figure>

<p>不变，说明configmap无法热更新环境变量。</p>
<h3 id="命令行参数"><a href="#命令行参数" class="headerlink" title="命令行参数"></a>命令行参数</h3><p>命令行参数本质上是环境变量的一种特殊情况。设置好环境变量后，在命令行参数中添加<code>$(ENV)</code>即可获取到环境变量。</p>
<p>configmap无法热更新环境变量，而命令行参数只在容器启动时使用，因此configmap无法热更新命令行参数，也没有必要。</p>
<h3 id="挂载数据卷"><a href="#挂载数据卷" class="headerlink" title="挂载数据卷"></a>挂载数据卷</h3><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kubectl create -f test-pod.yml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">alpine</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">alpine</span></span><br><span class="line">      <span class="attr">command:</span> <span class="string">[</span> <span class="string">"/bin/sleep"</span><span class="string">,</span> <span class="string">"3600"</span><span class="string">]</span></span><br><span class="line">      <span class="attr">volumeMounts:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test</span></span><br><span class="line">        <span class="attr">mountPath:</span> <span class="string">/test</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test</span></span><br><span class="line">      <span class="attr">configMap:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">test</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Never</span></span><br></pre></td></tr></table></figure>

<p>查看挂载的文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 test]# kubectl exec test -- cat &#x2F;test&#x2F;a</span><br><span class="line">1</span><br></pre></td></tr></table></figure>

<p>修改test-cm，等待一分钟后再次查看挂载的文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 test]# kubectl exec test -- cat &#x2F;test&#x2F;a</span><br><span class="line">2</span><br></pre></td></tr></table></figure>

<p>热更新成功。</p>
<h3 id="挂载数据卷（子路径）"><a href="#挂载数据卷（子路径）" class="headerlink" title="挂载数据卷（子路径）"></a>挂载数据卷（子路径）</h3><p>默认情况下，挂载数据卷方式将configmap挂载至一个文件夹，其中键为文件名，值为内容。</p>
<p>有时Pod需要多次挂载，每个挂载点只需要数据卷中的单个文件/文件夹，这个时候就需要使用子路径了。</p>
<p>如下，将数据卷中的a文件挂载至/test下：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kubectl apply -f test-pod.yml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">alpine</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">alpine</span></span><br><span class="line">      <span class="attr">command:</span> <span class="string">[</span> <span class="string">"/bin/sleep"</span><span class="string">,</span> <span class="string">"3600"</span><span class="string">]</span></span><br><span class="line">      <span class="attr">volumeMounts:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test</span></span><br><span class="line">        <span class="attr">mountPath:</span> <span class="string">/test</span></span><br><span class="line">        <span class="attr">subPath:</span> <span class="string">a</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test</span></span><br><span class="line">      <span class="attr">configMap:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">test</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Never</span></span><br></pre></td></tr></table></figure>

<p>查看test文件内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 test]# kubectl exec test -- cat &#x2F;test</span><br><span class="line">1</span><br></pre></td></tr></table></figure>

<p>修改test-cm后，再次查看test文件内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 test]# kubectl exec test -- cat &#x2F;test</span><br><span class="line">1</span><br></pre></td></tr></table></figure>

<p>没有变化，说明configmap无法热更新子路径方式的挂载数据卷。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>更新configmap后：</p>
<ul>
<li>使用该configmap的环境变量和命令行参数不会触发更新。</li>
<li>使用该configmap挂载的数据卷会触发更新。</li>
<li>如果使用子路径方式挂载的数据卷，将不会触发更新。</li>
</ul>
<h2 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h2><p>据官网所说，kubelet在每个同步周期中检查configmap是否更新，其获取方式分为两种，分别为从apiserver获取以及从本地缓存获取。在默认情况下，本地缓存更新周期和同步周期均为1分钟。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">When a ConfigMap already being consumed in a volume is updated, projected keys are eventually updated as well. Kubelet is checking whether the mounted ConfigMap is fresh on every periodic sync. However, it is using its local ttl-based cache for getting the current value of the ConfigMap. As a result, the total delay from the moment when the ConfigMap is updated to the moment when new keys are projected to the pod can be as long as kubelet sync period (1 minute by default) + ttl of ConfigMaps cache (1 minute by default) in kubelet.</span><br></pre></td></tr></table></figure>

<h3 id="configmap-manager-go"><a href="#configmap-manager-go" class="headerlink" title="configmap_manager.go"></a>configmap_manager.go</h3><p>首先看<code>pkg/kubelet/configmap/configmap_manager.go</code>，该文件定义了<code>Manager</code>接口，提供了Kubelet管理configmap的方法：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Manager interface provides methods for Kubelet to manage ConfigMap.</span></span><br><span class="line"><span class="keyword">type</span> Manager <span class="keyword">interface</span> &#123;</span><br><span class="line">	<span class="comment">// Get configmap by configmap namespace and name.</span></span><br><span class="line">	GetConfigMap(namespace, name <span class="keyword">string</span>) (*v1.ConfigMap, error)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// WARNING: Register/UnregisterPod functions should be efficient,</span></span><br><span class="line">	<span class="comment">// i.e. should not block on network operations.</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// RegisterPod registers all configmaps from a given pod.</span></span><br><span class="line">	RegisterPod(pod *v1.Pod)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// UnregisterPod unregisters configmaps from a given pod that are not</span></span><br><span class="line">	<span class="comment">// used by any other registered pod.</span></span><br><span class="line">	UnregisterPod(pod *v1.Pod)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结构体<code>configMapManager</code>实现了该接口，其<code>GetConfigMap</code>方法用于获取configmap：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *configMapManager)</span> <span class="title">GetConfigMap</span><span class="params">(namespace, name <span class="keyword">string</span>)</span> <span class="params">(*v1.ConfigMap, error)</span></span> &#123;</span><br><span class="line">	object, err := c.manager.GetObject(namespace, name)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> configmap, ok := object.(*v1.ConfigMap); ok &#123;</span><br><span class="line">		<span class="keyword">return</span> configmap, <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"unexpected object type: %v"</span>, object)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>函数<code>NewCachingConfigMapManager</code>用于初始化configMapManager：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// NewCachingConfigMapManager creates a manager that keeps a cache of all configmaps</span></span><br><span class="line"><span class="comment">// necessary for registered pods.</span></span><br><span class="line"><span class="comment">// It implement the following logic:</span></span><br><span class="line"><span class="comment">// - whenever a pod is create or updated, the cached versions of all configmaps</span></span><br><span class="line"><span class="comment">//   are invalidated</span></span><br><span class="line"><span class="comment">// - every GetObject() call tries to fetch the value from local cache; if it is</span></span><br><span class="line"><span class="comment">//   not there, invalidated or too old, we fetch it from apiserver and refresh the</span></span><br><span class="line"><span class="comment">//   value in cache; otherwise it is just fetched from cache</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewCachingConfigMapManager</span><span class="params">(kubeClient clientset.Interface, getTTL manager.GetObjectTTLFunc)</span> <span class="title">Manager</span></span> &#123;</span><br><span class="line">	getConfigMap := <span class="function"><span class="keyword">func</span><span class="params">(namespace, name <span class="keyword">string</span>, opts metav1.GetOptions)</span> <span class="params">(runtime.Object, error)</span></span> &#123;</span><br><span class="line">		<span class="keyword">return</span> kubeClient.CoreV1().ConfigMaps(namespace).Get(name, opts)</span><br><span class="line">	&#125;</span><br><span class="line">	configMapStore := manager.NewObjectStore(getConfigMap, clock.RealClock&#123;&#125;, getTTL, defaultTTL)</span><br><span class="line">	<span class="keyword">return</span> &amp;configMapManager&#123;</span><br><span class="line">		manager: manager.NewCacheBasedManager(configMapStore, getConfigMapNames),</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意注释，GetObject()函数尝试从本地缓存获取configmap，如果没有，不合法或已过期，则从apiserver获取并刷新缓存。</p>
<h3 id="kubelet-go"><a href="#kubelet-go" class="headerlink" title="kubelet.go"></a>kubelet.go</h3><p>再转到<code>pkg/kubelet/kubelet.go</code>文件，该文件负责kubelet的初始化工作。其调用了NewCachingConfigMapManager函数用于初始化configMapManager：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewMainKubelet</span><span class="params">(...)</span></span> &#123;</span><br><span class="line">    ...</span><br><span class="line">	<span class="keyword">switch</span> kubeCfg.ConfigMapAndSecretChangeDetectionStrategy &#123;</span><br><span class="line">	<span class="keyword">case</span> kubeletconfiginternal.WatchChangeDetectionStrategy:</span><br><span class="line">		secretManager = secret.NewWatchingSecretManager(kubeDeps.KubeClient)</span><br><span class="line">		configMapManager = configmap.NewWatchingConfigMapManager(kubeDeps.KubeClient)</span><br><span class="line">	<span class="keyword">case</span> kubeletconfiginternal.TTLCacheChangeDetectionStrategy:</span><br><span class="line">		secretManager = secret.NewCachingSecretManager(</span><br><span class="line">			kubeDeps.KubeClient, manager.GetObjectTTLFromNodeFunc(klet.GetNode))</span><br><span class="line">		configMapManager = configmap.NewCachingConfigMapManager(</span><br><span class="line">			kubeDeps.KubeClient, manager.GetObjectTTLFromNodeFunc(klet.GetNode))</span><br><span class="line">	<span class="keyword">case</span> kubeletconfiginternal.GetChangeDetectionStrategy:</span><br><span class="line">		secretManager = secret.NewSimpleSecretManager(kubeDeps.KubeClient)</span><br><span class="line">		configMapManager = configmap.NewSimpleConfigMapManager(kubeDeps.KubeClient)</span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"unknown configmap and secret manager mode: %v"</span>, kubeCfg.ConfigMapAndSecretChangeDetectionStrategy)</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>并在初始化<code>podManager</code>时与configMapManager绑定，其在更新和删除Pod时会检查并更新configmap状态：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// podManager is also responsible for keeping secretManager and configMapManager contents up-to-date.</span></span><br><span class="line">klet.podManager = kubepod.NewBasicPodManager(kubepod.NewBasicMirrorClient(klet.kubeClient), secretManager, configMapManager, checkpointManager)</span><br></pre></td></tr></table></figure>

<p><code>volumeManager</code>初始化时绑定了podManager，在更新configmap状态后，kubelet通过<code>volumeManager</code>更新Pod的数据卷：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewMainKubelet</span><span class="params">(...)</span></span> &#123;</span><br><span class="line">    ...</span><br><span class="line">	<span class="comment">// VolumeManager runs a set of asynchronous loops that figure out which</span></span><br><span class="line">	<span class="comment">// volumes need to be attached/mounted/unmounted/detached based on the pods</span></span><br><span class="line">	<span class="comment">// scheduled on this node and makes it so.</span></span><br><span class="line">	klet.volumeManager = volumemanager.NewVolumeManager(</span><br><span class="line">		kubeCfg.EnableControllerAttachDetach,</span><br><span class="line">		nodeName,</span><br><span class="line">		klet.podManager,</span><br><span class="line">		klet.statusManager,</span><br><span class="line">		klet.kubeClient,</span><br><span class="line">		klet.volumePluginMgr,</span><br><span class="line">		klet.containerRuntime,</span><br><span class="line">		kubeDeps.Mounter,</span><br><span class="line">		kubeDeps.HostUtil,</span><br><span class="line">		klet.getPodsDir(),</span><br><span class="line">		kubeDeps.Recorder,</span><br><span class="line">		experimentalCheckNodeCapabilitiesBeforeMount,</span><br><span class="line">		keepTerminatedPodVolumes,</span><br><span class="line">        volumepathhandler.NewBlockVolumePathHandler())</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后使用go协程运行<code>volumeManager</code>：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Start volume manager</span></span><br><span class="line"><span class="keyword">go</span> kl.volumeManager.Run(kl.sourcesReady, wait.NeverStop)</span><br></pre></td></tr></table></figure>

<h2 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h2><p>kubernetes.io: Mounted ConfigMaps are updated automatically：<a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-pod-configmap/#mounted-configmaps-are-updated-automatically" target="_blank" rel="noopener">https://kubernetes.io/docs/tasks/configure-pod-container/configure-pod-configmap/#mounted-configmaps-are-updated-automatically</a></p>
<p>jimmysong.io: configmap的热更新：<a href="https://jimmysong.io/kubernetes-handbook/concepts/configmap-hot-update.html" target="_blank" rel="noopener">https://jimmysong.io/kubernetes-handbook/concepts/configmap-hot-update.html</a></p>
<p>github: kubernetes: <a href="https://github.com/kubernetes/kubernetes" target="_blank" rel="noopener">https://github.com/kubernetes/kubernetes</a></p>

    </div>

    
    
    

      <footer class="post-footer">
          
          <div class="post-tags">
              <a href="/tags/%E5%AE%B9%E5%99%A8/" rel="tag"><i class="fa fa-tag"></i> 容器</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2019/09/16/%E5%9C%A8k8s%E4%B8%8A%E9%83%A8%E7%BD%B2elasticsearch/" rel="prev" title="在k8s上部署elasticsearch">
      <i class="fa fa-chevron-left"></i> 在k8s上部署elasticsearch
    </a></div>
      <div class="post-nav-item">
    <a href="/2019/09/20/event%E6%97%A5%E5%BF%97%E6%9F%A5%E8%AF%A2%E5%B7%A5%E5%85%B7/" rel="next" title="event日志查询工具">
      event日志查询工具 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#简介"><span class="nav-number">1.</span> <span class="nav-text">简介</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#热更新实践"><span class="nav-number">2.</span> <span class="nav-text">热更新实践</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#环境变量"><span class="nav-number">2.1.</span> <span class="nav-text">环境变量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#命令行参数"><span class="nav-number">2.2.</span> <span class="nav-text">命令行参数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#挂载数据卷"><span class="nav-number">2.3.</span> <span class="nav-text">挂载数据卷</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#挂载数据卷（子路径）"><span class="nav-number">2.4.</span> <span class="nav-text">挂载数据卷（子路径）</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#总结"><span class="nav-number">3.</span> <span class="nav-text">总结</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#源码分析"><span class="nav-number">4.</span> <span class="nav-text">源码分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#configmap-manager-go"><span class="nav-number">4.1.</span> <span class="nav-text">configmap_manager.go</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#kubelet-go"><span class="nav-number">4.2.</span> <span class="nav-text">kubelet.go</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#参考文档"><span class="nav-number">5.</span> <span class="nav-text">参考文档</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="staight"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">staight</p>
  <div class="site-description" itemprop="description">keep it simple and stupid</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">68</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">15</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">staight</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v4.2.0
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">主题 – <a href="https://mist.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a> v7.7.0
  </div>

        








      </div>
    </footer>
  </div>

  
  
  <script color='0,255,255' opacity='0.5' zIndex='-1' count='99' src="/lib/canvas-nest/canvas-nest.min.js"></script>
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

  <script type="text/javascript" async src="/js/ribbon.js"></script>
</body>
</html>
